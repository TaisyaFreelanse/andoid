# Инструкция по использованию комплексного сценария парсинга

## Описание сценария

Комплексный сценарий включает:

1. **Уникализация устройства** - установка прокси, подмена гео, установка таймзоны и языка
2. **Поиск в Google** - переход на google.com и поиск "site:pickuplineinsider.com"
3. **Переход на сайт** - клик по случайной ссылке из результатов поиска
4. **Парсинг баннеров** - 5-6 переходов внутри сайта с сбором параметра `addurl` с каждого баннера
5. **Повторение** - изменение Android ID, AAID, User-Agent, fingerprint и повтор всего процесса

## Структура задач

Сценарий состоит из **двух задач**, которые нужно выполнять последовательно:

### Задача 1: Уникализация устройства
**Файл:** `UNIQUENESS_SETUP.json`  
**Тип:** `uniqueness`  
**Описание:** Настраивает прокси, геолокацию, таймзону, язык и изменяет идентификаторы устройства

### Задача 2: Парсинг рекламных баннеров
**Файл:** `COMPLEX_SCENARIO.json`  
**Тип:** `parsing`  
**Описание:** Выполняет поиск в Google, переход на сайт и сбор `addurl` с баннеров

## Порядок выполнения

### Вариант 1: Ручное создание задач (для тестирования)

1. **Создайте первую задачу (уникализация):**
   - Откройте веб-интерфейс: https://android-automation-frontend.onrender.com/
   - Перейдите в раздел **"Задачи"** → **"Создать задачу"**
   - Заполните форму:
     - **Название:** "Уникализация устройства #1"
     - **Тип:** `uniqueness`
     - **Устройство:** выберите ваше устройство
     - **Конфигурация (JSON):** скопируйте содержимое файла `UNIQUENESS_SETUP.json`
   - Нажмите **"Создать"**

2. **Дождитесь завершения задачи уникализации:**
   - Статус должен измениться на **"completed"** ✅
   - Проверьте, что все изменения применены

3. **Создайте вторую задачу (парсинг):**
   - **Название:** "Парсинг баннеров #1"
   - **Тип:** `parsing`
   - **Устройство:** то же устройство
   - **Конфигурация (JSON):** скопируйте содержимое файла `COMPLEX_SCENARIO.json`
   - Нажмите **"Создать"**

4. **Повторите процесс:**
   - После завершения парсинга создайте новую задачу уникализации
   - Затем новую задачу парсинга
   - И так далее нужное количество раз

### Вариант 2: Автоматизация через API (для продакшена)

Для автоматизации можно использовать API бэкенда для создания задач в цикле:

```javascript
// Псевдокод для автоматизации
for (let i = 0; i < iterations; i++) {
  // 1. Создать задачу уникализации
  await createTask({
    name: `Уникализация #${i+1}`,
    type: 'uniqueness',
    configJson: uniquenessConfig
  });
  
  // 2. Дождаться завершения
  await waitForTaskCompletion(taskId);
  
  // 3. Создать задачу парсинга
  await createTask({
    name: `Парсинг баннеров #${i+1}`,
    type: 'parsing',
    configJson: parsingConfig
  });
  
  // 4. Дождаться завершения
  await waitForTaskCompletion(taskId);
}
```

## Что собирается

В результате выполнения задачи парсинга будут собраны:

- **Ссылки с баннеров** - все ссылки, содержащие параметр `addurl`
- **Домены из addurl** - извлеченные домены из параметра `addurl` (после дедупликации)
- **Метаданные** - информация о страницах, времени выполнения, скриншоты

### Ожидаемый результат

- **Количество страниц:** 6-7 (1 начальная + 5-6 переходов внутри сайта)
- **Баннеров на странице:** 5-8
- **Всего ссылок:** ~30-40 (с учетом повторений)
- **Уникальных доменов:** ~20-30 (после дедупликации)

## Результаты

После выполнения задачи парсинга результаты будут доступны:

1. **В веб-интерфейсе:**
   - Откройте задачу → раздел **"Результаты"**
   - В `resultJson.parsedData` будут все извлеченные данные
   - В `resultJson.adUrls` будут извлеченные домены из `addurl`

2. **В разделе "Parsed Data":**
   - Все извлеченные элементы с метаданными
   - Возможность экспорта в JSON/CSV

## Настройка параметров

### Изменение количества переходов

В файле `COMPLEX_SCENARIO.json` найдите:

```json
{
  "id": "step_15",
  "type": "loop",
  "max_iterations": 6,  // ← измените здесь (по умолчанию 6)
  ...
}
```

### Изменение поискового запроса

В файле `COMPLEX_SCENARIO.json` найдите:

```json
{
  "id": "step_3",
  "type": "input",
  "value": "site:pickuplineinsider.com",  // ← измените здесь
  ...
}
```

### Настройка прокси

Прокси настраивается автоматически через задачу уникализации. Убедитесь, что:
- Прокси добавлен в систему через веб-интерфейс
- Прокси активен и доступен
- В задаче уникализации используется `"proxy": "auto"` или конкретный `proxy_id`

## Требования

- ✅ **Root доступен** - устройство должно быть рутировано
- ✅ **Интернет подключен** - для доступа к Google и сайтам
- ✅ **Прокси настроен** - для подмены геолокации (опционально)

## Решение проблем

### Проблема: Задача уникализации не применяет изменения

**Решение:**
- Убедитесь, что root доступен (статус "✓ Доступен")
- Проверьте логи задачи на наличие ошибок
- Убедитесь, что устройство поддерживает изменение этих параметров

### Проблема: Не находится ссылка в результатах поиска Google

**Решение:**
- Увеличьте `timeout` для шага `step_9`
- Проверьте селектор - возможно, Google изменил структуру страницы
- Добавьте альтернативные селекторы в задачу

### Проблема: Собирается мало доменов из addurl

**Решение:**
- Увеличьте `max_iterations` в цикле (шаг `step_15`)
- Увеличьте время ожидания загрузки баннеров (`wait` шаги)
- Проверьте, что селекторы баннеров правильные

### Проблема: Баннеры не загружаются

**Решение:**
- Увеличьте `duration` в шагах `wait` после прокрутки
- Убедитесь, что `wait_for_ads: true` в конфигурации
- Проверьте, что прокси не блокирует рекламу

---

**Версия:** 1.0  
**Дата:** 2025-12-06

