Очередь задач (Redis + Bull)

Система очереди задач использует Redis и Bull для управления асинхронными задачами.

Конфигурация

 Типы задач

Система поддерживает 4 типа задач:

1. **surfing** - Серфинг по сайтам
   - Retry: 3 попытки
   - Backoff: экспоненциальный, начиная с 2 секунд

2. **parsing** - Парсинг данных
   - Retry: 4 попытки
   - Backoff: экспоненциальный, начиная с 3 секунд

3. **uniqueness** - Уникализация устройства
   - Retry: 5 попыток (критическая задача)
   - Backoff: экспоненциальный, начиная с 5 секунд

4. **screenshot** - Создание скриншота
   - Retry: 2 попытки
   - Backoff: экспоненциальный, начиная с 1 секунды

Приоритеты задач

Задачи могут иметь следующие приоритеты:

- `LOW` (1) - Низкий приоритет
- `NORMAL` (5) - Обычный приоритет (по умолчанию)
- `HIGH` (10) - Высокий приоритет
- `URGENT` (20) - Срочный приоритет

Использование

Добавление задачи в очередь

```typescript
import { addTaskToQueue, TaskPriority } from './queue/bull.config';

await addTaskToQueue({
  taskId: 'task-uuid',
  type: 'parsing',
  config: { /* конфигурация задачи */ },
  deviceId: 'device-uuid', 
  proxyId: 'proxy-uuid', 
  priority: TaskPriority.HIGH, 
});
```

 Мониторинг очереди

В режиме разработки доступен Bull Board по адресу:
- `http://localhost:3000/admin/queues`

Bull Board позволяет:
- Просматривать все задачи в очереди
- Видеть статус задач (waiting, active, completed, failed)
- Просматривать детали задач
- Повторно запускать failed задачи
- Очищать очередь

Обработка задач

Обработчик задач (`task.processor.ts`) автоматически:

1. Обновляет статус задачи на `running`
2. Назначает задачу на доступное устройство (если не указано)
3. Выбирает прокси (если требуется)
4. Обрабатывает задачу в зависимости от типа
5. Обновляет статус при успехе или ошибке

Retry механизм

Каждый тип задачи имеет свою конфигурацию retry:

- Количество попыток зависит от типа задачи
- Backoff стратегия: экспоненциальная (каждая следующая попытка ждет дольше)
- После исчерпания попыток задача помечается как `failed`

Очистка очереди

- Завершенные задачи хранятся 1 час (3600 секунд)
- Максимум 1000 завершенных задач
- Неудачные задачи хранятся 24 часа (86400 секунд)

 Логирование

Все события очереди логируются:
- `waiting` - задача ожидает обработки
- `active` - задача начала выполняться
- `completed` - задача успешно завершена
- `failed` - задача завершилась с ошибкой
- `stalled` - задача зависла (не отвечает)

Производительность

- Concurrency: до 10 задач одновременно
- Stalled interval: проверка каждые 30 секунд
- Max stalled count: 1 (после этого задача помечается как failed)

