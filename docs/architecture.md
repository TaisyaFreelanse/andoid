Архитектура системы автоматизации Android браузеров

Обзор системы

Система автоматизации браузеров на Android устройствах предназначена для:
- Автоматического серфинга по веб-сайтам через прокси
- Парсинга рекламных баннеров и извлечения данных
- Проверки доменов через Ahrefs API
- Уникализации устройств для обхода детекции
- Управления фермой из 20+ устройств параллельно

Компоненты системы

1. Backend Controller
- **Технологии:** Node.js, TypeScript, Fastify
- **Назначение:** Центральный сервер управления
- **Функции:**
  - REST API для управления устройствами и задачами
  - Обработка очереди задач через Bull
  - Интеграция с Ahrefs API
  - Управление хранением файлов (MinIO/S3)
  - WebSocket для real-time обновлений
  - JWT аутентификация и RBAC

2. Android Agent (APK)
- **Технологии:** Kotlin, Android SDK
- **Назначение:** Клиентское приложение на устройствах
- **Функции:**
  - Регистрация устройства на контроллере
  - Получение и выполнение задач
  - Управление браузером (Chrome/WebView)
  - Парсинг данных с веб-страниц
  - Уникализация устройства (root)
  - Загрузка скриншотов и результатов

3. Web UI
- **Технологии:** React, TypeScript, Vite
- **Назначение:** Веб-интерфейс для управления
- **Функции:**
  - Просмотр списка устройств и их статусов
  - Создание и управление задачами
  - Просмотр результатов парсинга
  - Просмотр скриншотов
  - Tail логов в реальном времени

4. PostgreSQL
- **Назначение:** Основная база данных
- **Хранит:**
  - Информацию об устройствах
  - Задачи и их результаты
  - Спарсенные данные
  - Результаты проверки Ahrefs
  - Прокси-серверы
  - Audit логи

5. Redis + Bull
- **Назначение:** Очередь задач
- **Функции:**
  - Распределение задач между устройствами
  - Приоритизация задач
  - Retry механизм
  - Мониторинг выполнения

6. MinIO/S3
- **Назначение:** Хранение файлов
- **Хранит:**
  - Скриншоты рекламных баннеров
  - Другие артефакты выполнения задач

Схема взаимодействия компонентов

```
┌─────────────┐
│   Web UI    │
│  (React)    │
└──────┬──────┘
       │ HTTP/WebSocket
       │
┌──────▼──────────────────────────────────────────────┐
│           Backend Controller                        │
│         (Node.js/Fastify)                           │
│                                                      │
│  ┌──────────┐  ┌──────────┐  ┌──────────┐          │
│  │   REST   │  │ WebSocket│  │   Auth   │          │
│  │   API    │  │  Server  │  │   JWT    │          │
│  └──────────┘  └──────────┘  └──────────┘          │
└──────┬──────────────┬──────────────┬───────────────┘
       │              │              │
       │              │              │
┌──────▼──────┐  ┌───▼──────┐  ┌───▼──────┐
│ PostgreSQL  │  │  Redis   │  │  MinIO   │
│             │  │  + Bull  │  │   /S3    │
└─────────────┘  └───────────┘  └──────────┘
       │
       │
┌──────▼──────────────────────────────────────────────┐
│         Android Agent (APK)                         │
│              (Kotlin)                                │
│                                                      │
│  ┌──────────┐  ┌──────────┐  ┌──────────┐          │
│  │ Browser  │  │  Parser  │  │Uniqueness│          │
│  │Controller│  │          │  │ Service  │          │
│  └──────────┘  └──────────┘  └──────────┘          │
└──────┬──────────────────────────────────────────────┘
       │
       │ HTTP/HTTPS
       │
┌──────▼──────┐      ┌──────────────┐
│ Proxy Server│      │ Ahrefs API   │
│  (External) │      │  (via Backend)│
└─────────────┘      └──────────────┘


Потоки данных

 1. Регистрация устройства

Android Agent → POST /api/agent/register
              → Backend проверяет данные
              → Сохранение в PostgreSQL (devices)
              → Возврат device_id и токена


 2. Получение и выполнение задачи

Android Agent → GET /api/agent/tasks (polling)
              → Backend проверяет очередь (Bull)
              → Назначение задачи устройству
              → Agent выполняет шаги задачи
              → POST /api/agent/tasks/:id/result
              → Backend сохраняет результаты в PostgreSQL


 3. Парсинг adurl и проверка Ahrefs

Android Agent → Парсинг страницы, извлечение adurl
              → POST /api/agent/tasks/:id/result (с ad_url)
              → Backend извлекает домен из ad_url
              → Проверка наличия в ahrefs_data (кеш)
              → Если нет → запрос к Ahrefs API
              → Сохранение в ahrefs_data и parsed_data


 4. Загрузка скриншотов

Android Agent → Создание скриншота
              → POST /api/agent/screenshot (multipart/form-data)
              → Backend загружает в MinIO
              → Сохранение пути в PostgreSQL (parsed_data)
              → Генерация presigned URL для доступа


 5. Heartbeat устройств

Android Agent → POST /api/agent/heartbeat (каждые 30 сек)
              → Backend обновляет last_heartbeat в devices
              → WebSocket уведомление для UI


 Технические детали

 Backend API
- **Порт:** 3000 (по умолчанию)
- **Протокол:** HTTP/HTTPS, WebSocket
- **Аутентификация:** JWT токены
- **Формат данных:** JSON

 Android Agent
- **Минимальная версия Android:** 7.0 (API 24)
- **Требования:** Root права
- **Интервал heartbeat:** 30 секунд
- **Интервал polling задач:** 10 секунд

 База данных
- **PostgreSQL версия:** 14+
- **Кодировка:** UTF-8
- **Таймзона:** UTC

 Очередь задач
- **Redis версия:** 6+
- **Bull версия:** 4+
- **Retry стратегия:** Exponential backoff
- **Максимум retry:** 3 попытки

 Хранение файлов
- **MinIO/S3:** Совместимый API
- **Структура папок:** `screenshots/{device_id}/{task_id}/{timestamp}.png`
- **Формат скриншотов:** PNG
- **Максимальный размер файла:** 10 MB

 Масштабируемость

 Текущие ограничения
- **Устройства:** 20 параллельно (тестирование)
- **Задачи в очереди:** до 1000
- **Размер БД:** до 100 GB

 Возможности масштабирования
- Горизонтальное масштабирование Backend (load balancer)
- Шардирование PostgreSQL
- Redis Cluster для больших нагрузок
- S3 вместо MinIO для облачного хранения

Безопасность

 Аутентификация
- JWT токены с истечением (24 часа)
- Refresh токены для продления сессии
- Отдельные токены для агентов (долгоживущие)

 Авторизация
- RBAC (Role-Based Access Control)
- Роли: admin, operator, viewer
- Проверка прав на уровне middleware

 Защита данных
- Шифрование прокси credentials в БД
- HTTPS для всех соединений
- Валидация всех входных данных
- Rate limiting для API

 Audit логирование
- Все действия пользователей
- Все действия агентов
- Ошибки и подозрительная активность

 Мониторинг и логирование

 Логирование
- Структурированные логи (JSON)
- Уровни: error, warn, info, debug
- Ротация логов (daily)
- Централизованное хранение

 Мониторинг
- Health check endpoints
- Метрики производительности
- Мониторинг очереди задач (Bull Board)
- Алерты при недоступности устройств

 Развертывание

### Docker Compose
- Все сервисы в контейнерах
- Автоматический запуск зависимостей
- Переменные окружения для конфигурации

 Требования к серверу
- **ОС:** Linux/Windows Server
- **RAM:** минимум 4 GB, рекомендуется 8 GB
- **CPU:** минимум 2 ядра, рекомендуется 4
- **Диск:** минимум 50 GB SSD
- **Сеть:** стабильное подключение к интернету

 Удаленное управление
- Поддержка RDP для Windows
- SSH для Linux
- Доступ к веб-интерфейсу через браузер

 Интеграции

 Ahrefs API
- Проверка доменов рекламодателей
- Кеширование результатов (24 часа)
- Обработка rate limits
- Сохранение полного JSON ответа
 Прокси серверы
- Поддержка HTTP/HTTPS/SOCKS5
- Ротация между задачами
- Проверка работоспособности
- Автоматическая замена при ошибке

 Резервное копирование

 База данных
- Ежедневные бэкапы PostgreSQL
- Хранение последних 7 дней
- Автоматическое восстановление

 Файлы
- Репликация MinIO/S3
- Версионирование файлов
- Политика удаления старых файлов (90 дней)



